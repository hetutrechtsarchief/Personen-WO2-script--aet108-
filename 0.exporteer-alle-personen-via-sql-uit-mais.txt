select ntni.code, ahd.id, ahd.guid, aew.fvd_id, fvd.prompt, aew.waarde, bes.bestandsnaam AS "Bestandsnaam (tmp)"
from archiefeenheden ahd
join archiefeenheid_waarden aew on ahd.id=aew.ahd_id
join ahd_relaties rel on rel.ahd_id=ahd.id
join ahd_bestanden bes on rel.ahd_id2=bes.ahd_id
join archiefeenheden ntni on ahd.ahd_id_top=ntni.id
join flexvelden fvd on fvd.id=aew.fvd_id
where ahd.aet_id=108 -- PSN (Persoon)
and ahd.dt > to_date('01-JAN-21','DD-MON-YY')
and aew.waarde is not null
and fvd_id not in (8415,8417,9771) -- date/user mutated, 9771=Bestandsnaam (tmp)
order by ahd.dt;




/*
Wanneer een adres eenmaal netjes aan de contexttoegang is gekoppeld 
(of eigenlijk wanneer Straatnaam+Huisnummer etc niet bij Persoon staat) 
moeten we extra moeite doen om het adres weer deel van de alle-personen lijst te maken (zoiets... huil)
*/

select adres.id as adres_id, adres.ahd_id as persoon_id, fvd_id, fvd.prompt, waarde from archiefeenheden adres
join archiefeenheid_waarden aew on adres.id=aew.ahd_id
join flexvelden fvd on fvd.id=aew.fvd_id
where adres.aet_id=366
and fvd_id in (4186, 4239, 4240, 9657) --adresvelden
and adres.ahd_id in (
    select id from archiefeenheden persoon
    where persoon.aet_id=108 --PSN
);
